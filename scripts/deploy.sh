#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะดะตะฟะปะพั ะฟัะพะดะฐะบัะฝ ะฒะตััะธะธ
set -e

echo "๐ ะะฐัะธะฝะฐะตะผ ะดะตะฟะปะพะน ะฟัะพะดะฐะบัะฝ ะฒะตััะธะธ..."

# ะะตัะตัะพะดะธะผ ะฒ ะบะพัะฝะตะฒัั ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
cd "$(dirname "$0")/.."

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต .env.production
if [ ! -f ".env.production" ]; then
    echo "โ ะคะฐะนะป .env.production ะฝะต ะฝะฐะนะดะตะฝ. ะกะพะทะดะฐะนัะต ะตะณะพ ะฝะฐ ะพัะฝะพะฒะต .env.production.example"
    exit 1
fi

# ะะพะฟะธััะตะผ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
cp .env.production .env

echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะต ะบะพะฝัะตะนะฝะตัั..."
docker-compose down --remove-orphans

echo "๐งน ะัะธัะฐะตะผ ะฝะตะธัะฟะพะปัะทัะตะผัะต ะพะฑัะฐะทั..."
docker system prune -f

echo "๐ฆ ะกะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั..."
docker-compose up -d --build

echo "โณ ะะดะตะผ ะทะฐะฟััะบะฐ ัะตัะฒะธัะพะฒ..."
sleep 30

echo "๐ ะัะพะฒะตััะตะผ ััะฐััั ัะตัะฒะธัะพะฒ..."
docker-compose ps

echo "๐ฅ ะัะพะฒะตััะตะผ ะทะดะพัะพะฒัะต ัะตัะฒะธัะพะฒ..."

# ะัะพะฒะตััะตะผ ะฑัะบะตะฝะด
echo "ะัะพะฒะตััะตะผ ะฑัะบะตะฝะด..."
if curl -f http://localhost:3001/api/health > /dev/null 2>&1; then
    echo "โ ะัะบะตะฝะด ัะฐะฑะพัะฐะตั"
else
    echo "โ ะัะบะตะฝะด ะฝะต ะพัะฒะตัะฐะตั"
    echo "๐ ะะพะณะธ ะฑัะบะตะฝะดะฐ:"
    docker-compose logs backend
    exit 1
fi

# ะัะพะฒะตััะตะผ ััะพะฝัะตะฝะด
echo "ะัะพะฒะตััะตะผ ััะพะฝัะตะฝะด..."
if curl -f http://localhost:80 > /dev/null 2>&1; then
    echo "โ ะคัะพะฝัะตะฝะด ัะฐะฑะพัะฐะตั"
else
    echo "โ ะคัะพะฝัะตะฝะด ะฝะต ะพัะฒะตัะฐะตั"
    echo "๐ ะะพะณะธ ััะพะฝัะตะฝะดะฐ:"
    docker-compose logs frontend
    exit 1
fi

echo "๐ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ ััะฟะตัะฝะพ!"
echo "๐ ะัะธะปะพะถะตะฝะธะต ะดะพัััะฟะฝะพ ะฟะพ ะฐะดัะตัั: http://localhost"
echo "๐ ะะปั ะฟัะพัะผะพััะฐ ะปะพะณะพะฒ: docker-compose logs -f"
echo "๐ ะะปั ะพััะฐะฝะพะฒะบะธ: ./scripts/stop.sh"
echo "๐ ะะปั ะฟะตัะตะทะฐะฟััะบะฐ: ./scripts/restart.sh"